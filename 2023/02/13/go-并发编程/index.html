<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Goâ€”å¹¶å‘ç¼–ç¨‹ | xcc</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo/profile2.png">
    <meta name="description" content="CSPæ¨¡å‹æ˜¯Goè¯­è¨€æ”¯æŒçš„ä¸»æµå¹¶å‘æ¨¡å‹ï¼ŒGoè¿˜æ”¯æŒä¼ ç»Ÿçš„ã€åŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹ï¼Œå¹¶æä¾›äº†åŸºæœ¬çš„ä½çº§åˆ«åŒæ­¥åŸè¯­ï¼ˆäº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”ã€åŸå­æ“ä½œç­‰ï¼‰ã€‚">
    
    <link rel="preload" href="/assets/css/0.styles.fe33cd63.css" as="style"><link rel="preload" href="/assets/js/app.8f62a037.js" as="script"><link rel="preload" href="/assets/js/6.b8e708a3.js" as="script"><link rel="preload" href="/assets/js/3.3f44ea24.js" as="script"><link rel="preload" href="/assets/js/43.23bd57f8.js" as="script"><link rel="prefetch" href="/assets/js/10.2a29879b.js"><link rel="prefetch" href="/assets/js/11.465376b6.js"><link rel="prefetch" href="/assets/js/12.16ec2088.js"><link rel="prefetch" href="/assets/js/13.8401e0b9.js"><link rel="prefetch" href="/assets/js/14.128da524.js"><link rel="prefetch" href="/assets/js/15.5325ae8c.js"><link rel="prefetch" href="/assets/js/16.0c396afd.js"><link rel="prefetch" href="/assets/js/17.e1ea1411.js"><link rel="prefetch" href="/assets/js/18.1743c483.js"><link rel="prefetch" href="/assets/js/19.8372c7a4.js"><link rel="prefetch" href="/assets/js/20.a57b6ac2.js"><link rel="prefetch" href="/assets/js/21.309ad047.js"><link rel="prefetch" href="/assets/js/22.3749550e.js"><link rel="prefetch" href="/assets/js/23.befc7934.js"><link rel="prefetch" href="/assets/js/24.91c37a3e.js"><link rel="prefetch" href="/assets/js/25.e5e36c46.js"><link rel="prefetch" href="/assets/js/26.924d4716.js"><link rel="prefetch" href="/assets/js/27.7dd0ab4c.js"><link rel="prefetch" href="/assets/js/28.35f2f03c.js"><link rel="prefetch" href="/assets/js/29.834ade1f.js"><link rel="prefetch" href="/assets/js/30.9188c9d2.js"><link rel="prefetch" href="/assets/js/31.4cc890a9.js"><link rel="prefetch" href="/assets/js/32.86a374c5.js"><link rel="prefetch" href="/assets/js/33.3d4d3929.js"><link rel="prefetch" href="/assets/js/34.78d62ab7.js"><link rel="prefetch" href="/assets/js/35.369fe440.js"><link rel="prefetch" href="/assets/js/36.5f19581b.js"><link rel="prefetch" href="/assets/js/37.71cf5d2f.js"><link rel="prefetch" href="/assets/js/38.c12daea6.js"><link rel="prefetch" href="/assets/js/39.06d5dabf.js"><link rel="prefetch" href="/assets/js/4.84b14fb6.js"><link rel="prefetch" href="/assets/js/40.54fb0199.js"><link rel="prefetch" href="/assets/js/41.de50fdc7.js"><link rel="prefetch" href="/assets/js/42.8ccab7c2.js"><link rel="prefetch" href="/assets/js/44.87e89878.js"><link rel="prefetch" href="/assets/js/45.274dc43c.js"><link rel="prefetch" href="/assets/js/46.7b84b85a.js"><link rel="prefetch" href="/assets/js/47.566aeb5f.js"><link rel="prefetch" href="/assets/js/48.338cc282.js"><link rel="prefetch" href="/assets/js/5.8613c109.js"><link rel="prefetch" href="/assets/js/7.e3359995.js"><link rel="prefetch" href="/assets/js/8.a97dd115.js"><link rel="prefetch" href="/assets/js/9.27a33244.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.d9e995a1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fe33cd63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">xcc </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="https://rebel-writer-12b.notion.site/Engineering-Wiki-6f04c16f81ed4fbd8f6d599237c98dfe" target="_blank" rel="noopener noreferrer" class="nav-link external">Notions</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">xcc </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="https://rebel-writer-12b.notion.site/Engineering-Wiki-6f04c16f81ed4fbd8f6d599237c98dfe" target="_blank" rel="noopener noreferrer" class="nav-link external">Notions</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Goâ€”å¹¶å‘ç¼–ç¨‹
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">xucongcong</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2023-02-13T00:00:00.000Z">
      2023-02-13
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-532d3a9c><a href="/tag/Go" data-v-532d3a9c><span data-v-532d3a9c>Go</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>Go è¯­è¨€ä»è®¾è®¡ä¼Šå§‹ï¼Œå°±å°†è§£å†³ä¼ ç»Ÿå¹¶å‘æ¨¡å‹çš„é—®é¢˜ä½œä¸º Go çš„ä¸€ä¸ªç›®æ ‡ï¼Œå¹¶åœ¨æ–°å¹¶å‘æ¨¡å‹è®¾è®¡ä¸­å€Ÿé‰´äº†è‘—åè®¡ç®—æœºç§‘å­¦å®¶Tony Hoareæå‡ºçš„ CSPï¼ˆCommunicating Sequential Processesï¼‰å¹¶å‘æ¨¡å‹ã€‚</p> <p>è™½ç„¶ CSP æ¨¡å‹å·²ç»æˆä¸º Go è¯­è¨€æ”¯æŒçš„ä¸»æµå¹¶å‘æ¨¡å‹ï¼Œä½† Go ä¹Ÿæ”¯æŒä¼ ç»Ÿçš„ã€åŸºäºå…±äº«å†…å­˜çš„å¹¶å‘æ¨¡å‹ï¼Œå¹¶æä¾›äº†åŸºæœ¬çš„ä½çº§åˆ«åŒæ­¥åŸè¯­ï¼ˆsync åŒ…ä¸­çš„äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”ã€åŸå­æ“ä½œç­‰ï¼‰ã€‚</p> <h2 id="_1-goroutine"><a href="#_1-goroutine" class="header-anchor">#</a> 1. goroutine</h2> <p>main å‡½æ•°ä¼šé»˜è®¤å¯åŠ¨ä¸€ä¸ª goroutine å»æ‰§è¡Œã€‚</p> <p>å¯åŠ¨ä¸€ä¸ª goroutineï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">sayhi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;start sayhi!&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">sayhi</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;after start sayhi!&quot;</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">6</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">// ä¸»åç¨‹å†…å®¹æ‰§è¡Œå®Œåï¼Œå­ åç¨‹ä¼šé€€å‡ºï¼Œæ‰€ä»¥è¿™é‡Œç­‰å¾…</span>
<span class="token punctuation">}</span>
</code></pre></div><aside>
ğŸ’¡ é™¤äº†ä»mainè¿”å›æˆ–è€…é€€å‡ºç¨‹åºï¼Œæ²¡æœ‰ç¨‹åºåŒ–çš„æ–¹æ³•è®©ä¸€ä¸ªgoroutineåœæ­¢ï¼Œåªèƒ½é€šè¿‡é€šä¿¡è®©å…¶è‡ªå·±åœæ­¢ã€‚
</aside> <h2 id="_2-åŸºäºcspæ¨¡å‹å®ç°å¹¶å‘"><a href="#_2-åŸºäºcspæ¨¡å‹å®ç°å¹¶å‘" class="header-anchor">#</a> 2. åŸºäºCSPæ¨¡å‹å®ç°å¹¶å‘</h2> <p>Go è¯­è¨€å¹¶å‘æ¨¡å‹æå€¡ä½¿ç”¨CSPå¹¶å‘æ¨¡å‹ã€‚åœ¨Goä¸­ï¼Œä¸â€œProcessâ€å¯¹åº”çš„æ˜¯ goroutineã€‚ä¸ºäº†å®ç° CSP å¹¶å‘æ¨¡å‹ä¸­çš„è¾“å…¥å’Œè¾“å‡ºåŸè¯­ï¼ŒGo è¿˜å¼•å…¥äº† goroutineï¼ˆPï¼‰ä¹‹é—´çš„é€šä¿¡åŸè¯­channelã€‚</p> <h3 id="_2-1-channel"><a href="#_2-1-channel" class="header-anchor">#</a> 2.1 channel</h3> <hr> <p>åŸºæœ¬æ“ä½œï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// åˆ›å»ºä¸€ä¸ªintå‹çš„channel</span>
<span class="token keyword">var</span> ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> in<span class="token punctuation">)</span>

<span class="token comment">// å‘é€åˆ°channel</span>
ch <span class="token operator">&lt;-</span> <span class="token number">10</span>

<span class="token comment">// æ¥æ”¶</span>
data <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch  <span class="token comment">// æ¥æ”¶å¹¶èµ‹å€¼</span>
<span class="token operator">&lt;-</span> ch          <span class="token comment">// æ¥æ”¶å¹¶å¿½ç•¥ç»“æœ</span>

<span class="token comment">// å…³é—­</span>
<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
</code></pre></div><p>å…³äºå…³é—­channelï¼šåªæœ‰åœ¨é€šçŸ¥æ¥æ”¶æ–¹æ•°æ®å‘é€å®Œæ¯•æ—¶æ‰éœ€å…³é—­ã€‚</p> <p>å¯¹ä¸å…³é—­åçš„channelï¼š</p> <ul><li>å‘ä¸€ä¸ªå…³é—­çš„channelå‘é€å€¼ä¼šå¯¼è‡´panic</li> <li>å…³é—­ä¸€ä¸ªå·²å…³é—­çš„channelä¼šå¯¼è‡´panic</li> <li>ä»ä¸€ä¸ªå…³é—­çš„é€šé“æ¥æ”¶å€¼ä¼šä¸€è‡´æˆ–å–å€¼ï¼Œåªåˆ°ä¸ºç©º</li> <li>ä»ä¸€ä¸ªå·²å…³é—­ä¸”æ²¡æœ‰å€¼çš„channelæ‰§è¡Œæ¥æ”¶æ“ä½œä¼šå¾—åˆ°å¯¹åº”ç±»å‹çš„é»˜è®¤å€¼</li></ul> <p>æ— ç¼“å†²channelï¼ˆå®ç°åŒæ­¥ï¼‰ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span> <span class="token comment">// å¤±è´¥ï¼Œæ— ç¼“å†²çš„channelå¿…é¡»æœ‰äººæ¥æ”¶æ‰èƒ½å‘é€ï¼Œå¦åˆ™ä¼šé˜»å¡å½¢æˆæ­»é”</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ‰ç¼“å†²channelï¼ˆå®ç°å¼‚æ­¥ï¼‰ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">receive</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;å¼€å§‹æ¥æ”¶&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		data <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch <span class="token comment">// é˜»å¡æ“ä½œ</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;received: &quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">receive</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;len, cap =&gt;&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// len, cap =&gt; 0 5</span>

	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">20</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€æˆåŠŸ&quot;</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ¤æ–­channelæ˜¯å¦è¿˜èƒ½å–å€¼ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// æ–¹å¼1</span>
data<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch      <span class="token comment">// channelå·²å…³é—­ä¸”æ²¡æœ‰å€¼æ—¶ï¼Œok=false</span>

<span class="token comment">// æ–¹å¼2</span>
<span class="token keyword">for</span> data <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span> <span class="token comment">// channelå·²å…³é—­ä¸”æ²¡æœ‰å€¼æ—¶ï¼Œä¼šè‡ªåŠ¨é€€å‡ºforè¿­ä»£</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;received: &quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é™åˆ¶é€šé“çš„æ“ä½œï¼ˆå•å‘é€šé“ï¼‰ï¼šåœ¨ä¼ é€’channelç»™å¤šä¸ªgoroutineæ—¶ï¼Œå¯ä»¥åœ¨ä¼ å‚æ—¶é™åˆ¶é€šé“æ–¹å‘ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">receive</span><span class="token punctuation">(</span>ch <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// åªè¯»channel</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;å¼€å§‹æ¥æ”¶&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> data <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;received: &quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;é€€å‡ºforè¿­ä»£&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">produce</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">// åªå†™channel</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;å¼€å§‹å‘é€&quot;</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">20</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">20</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;å‘é€å®Œæ¯•&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">produce</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">receive</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;main close&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-2-selectå¤šè·¯å¤ç”¨"><a href="#_2-2-selectå¤šè·¯å¤ç”¨" class="header-anchor">#</a> 2.2 selectå¤šè·¯å¤ç”¨</h3> <hr> <p>ä»channelæ¥æ”¶æ•°æ®æ˜¯é˜»å¡æ“ä½œï¼Œå¦‚æœéœ€è¦ä»å¤šä¸ªchannelæ¥æ”¶æ•°æ®ï¼Œä¸€èˆ¬é€šè¿‡è½®è®­å¤„ç†ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">receive</span><span class="token punctuation">(</span>ch1<span class="token punctuation">,</span> ch2 <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;å¼€å§‹æ¥æ”¶&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		data<span class="token punctuation">,</span> ok1 <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch1
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;recevie ch1 data =&gt;&quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">,</span>ok1<span class="token punctuation">)</span>
		data2<span class="token punctuation">,</span> ok2 <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch2
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;recevie ch2 data =&gt;&quot;</span><span class="token punctuation">,</span>data2<span class="token punctuation">,</span>ok2<span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">produce1</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;p1 å¼€å§‹å‘é€&quot;</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">20</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">20</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;p1å‘é€å®Œæ¯•&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">produce2</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;p2 å¼€å§‹å‘é€&quot;</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">100</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">200</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">100</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">200</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">100</span>
	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;p2 å‘é€å®Œæ¯•&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	ch2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">produce1</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">produce2</span><span class="token punctuation">(</span>ch2<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">receive</span><span class="token punctuation">(</span>ch1<span class="token punctuation">,</span> ch2<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;main close&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è½®è®­æ€§èƒ½å¾ˆå·®ï¼ŒåŒæ—¶ä»å¤šä¸ªchannelæ¥æ”¶æ•°æ®å¯ä»¥ä½¿ç”¨selectå…³é”®å­—ã€‚selectæ“ä½œç±»ä¼¼switchè¯­å¥ï¼Œæœ‰å¤šä¸ªåˆ†æ”¯ï¼Œselectä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°æŸä¸ªcaseå¯ç”¨ï¼Œä¸Šä¾‹æ”¹é€ åï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">receive</span><span class="token punctuation">(</span>ch1<span class="token punctuation">,</span> ch2 <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;å¼€å§‹æ¥æ”¶&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> data1<span class="token punctuation">,</span>ok1 <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch1<span class="token punctuation">:</span>
			<span class="token keyword">if</span> ok1 <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;recevie ch1 data =&gt;&quot;</span><span class="token punctuation">,</span> data1<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> data2<span class="token punctuation">,</span>ok2 <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch2<span class="token punctuation">:</span>
			<span class="token keyword">if</span> ok2 <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;recevie ch2 data =&gt;&quot;</span><span class="token punctuation">,</span> data2<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥é…åˆ time.Ticker ä¸ºåç¨‹è®¾å®šè¶…æ—¶æ—¶é—´ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code>timer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span> ch<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;receieved from ch =&gt;&quot;</span><span class="token punctuation">,</span> ch<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span> timer<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;timeout wating from ch&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-åŸºäºå…±äº«å˜é‡å®ç°å¹¶å‘"><a href="#_3-åŸºäºå…±äº«å˜é‡å®ç°å¹¶å‘" class="header-anchor">#</a> 3. åŸºäºå…±äº«å˜é‡å®ç°å¹¶å‘</h2> <h3 id="_3-1-åŒæ­¥-sync-waitgroup"><a href="#_3-1-åŒæ­¥-sync-waitgroup" class="header-anchor">#</a> 3.1 åŒæ­¥ sync.WaitGroup</h3> <hr> <p>åŒæ­¥ï¼šå°±æ˜¯å¹¶å‘è¿›ç¨‹/çº¿ç¨‹åœ¨ä¸€äº›å…³é”®ç‚¹ä¸Šå¯èƒ½éœ€è¦äº’ç›¸ç­‰å¾…ä¸äº’é€šæ¶ˆæ¯ï¼Œè¿™ç§ç›¸äº’åˆ¶çº¦çš„ç­‰å¾…ä¸äº’é€šä¿¡æ¯ç§°ä¸ºè¿›ç¨‹/çº¿ç¨‹åŒæ­¥ã€‚ä»¥ä¸‹ç¤ºä¾‹é€šè¿‡syncåŒ…ä¸‹çš„WaitGroupå®ç°åŒæ­¥ã€‚</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token keyword">var</span> monney <span class="token operator">=</span> <span class="token number">100</span>

<span class="token keyword">func</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	monney <span class="token operator">+=</span> <span class="token number">1</span> 
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">dec1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	monney <span class="token operator">-=</span> <span class="token number">1</span> 
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token function">dec1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;money =&gt;&quot;</span><span class="token punctuation">,</span> monney<span class="token punctuation">)</span> <span class="token comment">// moneyæœ€ç»ˆç»“æœå¯èƒ½ä¸æ˜¯100</span>
<span class="token punctuation">}</span>
</code></pre></div><aside>
ğŸ’¡ ä¹Ÿå¯ä»¥é€šè¿‡channelå®ç°ç›¸åŒçš„åŒæ­¥æ•ˆæœ
</aside> <h3 id="_3-2-äº’æ–¥é”-sync-mutex"><a href="#_3-2-äº’æ–¥é”-sync-mutex" class="header-anchor">#</a> 3.2 äº’æ–¥é” sync.Mutex</h3> <hr> <p>3.1 ä¾‹ä¸­å¹¶å‘ç«äº‰å…±äº«èµ„æºçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨äº’æ–¥é”æ¥é¿å…èµ„æºç«äº‰é€ æˆçš„èµ„æºæ··ä¹±ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token keyword">var</span> lock sync<span class="token punctuation">.</span>Mutex
<span class="token keyword">var</span> monney <span class="token operator">=</span> <span class="token number">100</span>

<span class="token keyword">func</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	monney <span class="token operator">+=</span> <span class="token number">1</span>
	lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">dec1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	monney <span class="token operator">-=</span> <span class="token number">1</span>
	lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token function">dec1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;money =&gt;&quot;</span><span class="token punctuation">,</span> monney<span class="token punctuation">)</span> <span class="token comment">// moneyæœ€ç»ˆç»“æœå¯èƒ½ä¸æ˜¯100</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-3-è¯»å†™é”-sync-rwmutex"><a href="#_3-3-è¯»å†™é”-sync-rwmutex" class="header-anchor">#</a> 3.3 è¯»å†™é” sync.RWMutex</h3> <hr> <p>äº’æ–¥é”æ˜¯å®Œå…¨äº’æ–¥çš„ï¼ˆæ— è®ºæ˜¯è¯»è¿˜æ˜¯å†™ï¼‰ï¼Œè€Œå¹¶å‘è¯»æ“ä½œå¯ä»¥ä¸åŠ é”ï¼Œè¿™æ ·å¯ä»¥æå‡æ€§èƒ½ã€‚è¯»å†™é”éå¸¸é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚</p> <p>ç¤ºä¾‹ï¼šè®¾è¯»æ“ä½œæ¶ˆè€—1msï¼Œå†™æ“ä½œæ¶ˆè€—10msï¼Œåˆ†åˆ«å¯åŠ¨<strong>1000</strong>ä¸ªè¯»ã€<strong>10</strong>ä¸ªå†™åç¨‹æµ‹è¯•è€—æ—¶</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// ä½¿ç”¨äº’æ–¥é”</span>

<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token keyword">var</span> lock sync<span class="token punctuation">.</span>Mutex
<span class="token keyword">var</span> monney <span class="token operator">=</span> <span class="token number">100</span>

<span class="token keyword">func</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span>
	lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	monney <span class="token operator">+=</span> <span class="token number">1</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
	lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;spend time =&gt;&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// ä½¿ç”¨è¯»å†™é”</span>
<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
<span class="token keyword">var</span> lock sync<span class="token punctuation">.</span>RWMutex
<span class="token keyword">var</span> monney <span class="token operator">=</span> <span class="token number">100</span>

<span class="token keyword">func</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span>
	lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	monney <span class="token operator">+=</span> <span class="token number">1</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
	lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;spend time =&gt;&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><aside>
ğŸ’¡ æµ‹è¯•ç»“æœï¼šåŸºäºäº’æ–¥é”çº¦è€—æ—¶1.2ç§’ï¼ŒåŸºäºè¯»å†™é”çº¦è€—æ—¶100æ¯«ç§’
</aside> <p>è¯»å†™é”çš„åŸºæœ¬ç”¨æ³•ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> wrlock sync<span class="token punctuation">.</span>RWMutex

wrlock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// ä¸Šå†™é”</span>
wrlock<span class="token punctuation">.</span><span class="token function">ULock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// è§£å†™é”</span>
wrlock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// ä¸Šè¯»é”</span>
wrlock<span class="token punctuation">.</span><span class="token function">ULock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// è§£è¯»é”</span>
</code></pre></div><h3 id="_3-4-æ¡ä»¶å˜é‡-sync-cond"><a href="#_3-4-æ¡ä»¶å˜é‡-sync-cond" class="header-anchor">#</a> 3.4 æ¡ä»¶å˜é‡ sync.Cond</h3> <hr> <p>è®©ä¸€ç»„goroutineåœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶è¢«å”¤é†’</p> <ul><li>cond.Lock()</li> <li>cond.Unlock()</li> <li>cond.Wait()</li> <li>cond.Signal()ï¼šéšæœºé€šçŸ¥ä¸€ä¸ª</li> <li>cond.Broadcase()ï¼šé€šçŸ¥æ‰€æœ‰</li></ul> <hr> <p>ä¿è¯æŸæ®µä»£ç åªæ‰§è¡Œä¸€æ¬¡</p> <h2 id="_4-åŸå­æ“ä½œ-atomic"><a href="#_4-åŸå­æ“ä½œ-atomic" class="header-anchor">#</a> 4. åŸå­æ“ä½œ atomic</h2> <p>åŠ é”æ¶‰åŠåˆ°å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»£ä»·è¾ƒé«˜ã€‚å¯¹ä¸åŸºæœ¬æ•°æ®ç±»å‹çš„èµ„æºç«äº‰ï¼ŒGo çš„ atomic åŒ…æä¾›ç”¨æˆ·æ€çš„åŸå­æ“ä½œï¼Œæ€§èƒ½æ›´é«˜ã€‚</p> <p>ç¤ºä¾‹ï¼š</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;sync/atomic&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> x <span class="token builtin">int64</span>
<span class="token keyword">var</span> l sync<span class="token punctuation">.</span>Mutex
<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

<span class="token comment">// æ™®é€šç‰ˆåŠ å‡½æ•°</span>
<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// x = x + 1</span>
    x<span class="token operator">++</span> <span class="token comment">// ç­‰ä»·äºä¸Šé¢çš„æ“ä½œ</span>
    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// äº’æ–¥é”ç‰ˆåŠ å‡½æ•°</span>
<span class="token keyword">func</span> <span class="token function">mutexAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    l<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    x<span class="token operator">++</span>
    l<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// åŸå­æ“ä½œç‰ˆåŠ å‡½æ•°</span>
<span class="token keyword">func</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// go add()       // æ™®é€šç‰ˆaddå‡½æ•° ä¸æ˜¯å¹¶å‘å®‰å…¨çš„</span>
        <span class="token comment">// go mutexAdd()  // åŠ é”ç‰ˆaddå‡½æ•° æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œä½†æ˜¯åŠ é”æ€§èƒ½å¼€é”€å¤§</span>
        <span class="token keyword">go</span> <span class="token function">atomicAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// åŸå­æ“ä½œç‰ˆaddå‡½æ•° æ˜¯å¹¶å‘å®‰å…¨ï¼Œæ€§èƒ½ä¼˜äºåŠ é”ç‰ˆ</span>
    <span class="token punctuation">}</span>
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    end <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>end<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="header-anchor">#</a> å‚è€ƒæ–‡æ¡£</h2> <ul><li><p><a href="https://time.geekbang.org/column/article/478192" target="_blank" rel="noopener noreferrer">34ï½œå¹¶å‘ï¼šå¦‚ä½•ä½¿ç”¨å…±äº«å˜é‡ï¼Ÿ-æå®¢æ—¶é—´<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://chai2010.cn/advanced-go-programming-book/ch1-basic/ch1-06-goroutine.html" target="_blank" rel="noopener noreferrer">å¸¸è§çš„å¹¶å‘æ¨¡å¼ - Goè¯­è¨€é«˜çº§ç¼–ç¨‹<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1-goroutine" title="1. goroutine">1. goroutine</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-åŸºäºcspæ¨¡å‹å®ç°å¹¶å‘" title="2. åŸºäºCSPæ¨¡å‹å®ç°å¹¶å‘">2. åŸºäºCSPæ¨¡å‹å®ç°å¹¶å‘</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-1-channel" title="2.1 channel">2.1 channel</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-2-selectå¤šè·¯å¤ç”¨" title="2.2 selectå¤šè·¯å¤ç”¨">2.2 selectå¤šè·¯å¤ç”¨</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3-åŸºäºå…±äº«å˜é‡å®ç°å¹¶å‘" title="3. åŸºäºå…±äº«å˜é‡å®ç°å¹¶å‘">3. åŸºäºå…±äº«å˜é‡å®ç°å¹¶å‘</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-1-åŒæ­¥-sync-waitgroup" title="3.1 åŒæ­¥ sync.WaitGroup">3.1 åŒæ­¥ sync.WaitGroup</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-2-äº’æ–¥é”-sync-mutex" title="3.2 äº’æ–¥é” sync.Mutex">3.2 äº’æ–¥é” sync.Mutex</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-3-è¯»å†™é”-sync-rwmutex" title="3.3 è¯»å†™é” sync.RWMutex">3.3 è¯»å†™é” sync.RWMutex</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-4-æ¡ä»¶å˜é‡-sync-cond" title="3.4 æ¡ä»¶å˜é‡ sync.Cond">3.4 æ¡ä»¶å˜é‡ sync.Cond</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_4-åŸå­æ“ä½œ-atomic" title="4. åŸå­æ“ä½œ atomic">4. åŸå­æ“ä½œ atomic</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#å‚è€ƒæ–‡æ¡£" title="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</a></div></div></div></div> <footer class="footer" data-v-8eb634d6><div class="footer-left-wrap" data-v-8eb634d6><ul class="contact" data-v-8eb634d6><li class="contact-item" data-v-8eb634d6><a href="https://github.com/awesomexu" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-8eb634d6><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-8eb634d6></path></svg>
          
        </a></li><li class="contact-item" data-v-8eb634d6><a href="mailto:xcc_mail@163.com" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-8eb634d6><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-8eb634d6></path><polyline points="22,6 12,13 2,6" data-v-8eb634d6></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-8eb634d6><ul class="copyright" data-v-8eb634d6><li class="copyright-item" data-v-8eb634d6><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6>Privacy Policy</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8f62a037.js" defer></script><script src="/assets/js/6.b8e708a3.js" defer></script><script src="/assets/js/3.3f44ea24.js" defer></script><script src="/assets/js/43.23bd57f8.js" defer></script>
  </body>
</html>
