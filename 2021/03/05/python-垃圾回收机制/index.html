<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python—垃圾回收机制 | xcc</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo/profile2.png">
    <meta name="description" content="Python中垃圾收集器使用基于引用计数的方法。它在程序执行期间运行，并在对象的引用计数达到0时开始工作">
    
    <link rel="preload" href="/assets/css/0.styles.6ee2d4db.css" as="style"><link rel="preload" href="/assets/js/app.56bca4c3.js" as="script"><link rel="preload" href="/assets/js/6.80680de3.js" as="script"><link rel="preload" href="/assets/js/3.3f44ea24.js" as="script"><link rel="preload" href="/assets/js/24.44b9af71.js" as="script"><link rel="prefetch" href="/assets/js/10.2a29879b.js"><link rel="prefetch" href="/assets/js/11.465376b6.js"><link rel="prefetch" href="/assets/js/12.16ec2088.js"><link rel="prefetch" href="/assets/js/13.8401e0b9.js"><link rel="prefetch" href="/assets/js/14.75077afb.js"><link rel="prefetch" href="/assets/js/15.310ef410.js"><link rel="prefetch" href="/assets/js/16.2a04d5c4.js"><link rel="prefetch" href="/assets/js/17.02ce7000.js"><link rel="prefetch" href="/assets/js/18.536f9bd8.js"><link rel="prefetch" href="/assets/js/19.c4cb270f.js"><link rel="prefetch" href="/assets/js/20.a57b6ac2.js"><link rel="prefetch" href="/assets/js/21.6ca00cc5.js"><link rel="prefetch" href="/assets/js/22.3749550e.js"><link rel="prefetch" href="/assets/js/23.35d5499b.js"><link rel="prefetch" href="/assets/js/25.fc6e1433.js"><link rel="prefetch" href="/assets/js/26.924d4716.js"><link rel="prefetch" href="/assets/js/27.7dd0ab4c.js"><link rel="prefetch" href="/assets/js/28.862644b3.js"><link rel="prefetch" href="/assets/js/29.00da344c.js"><link rel="prefetch" href="/assets/js/30.9188c9d2.js"><link rel="prefetch" href="/assets/js/31.cd584b14.js"><link rel="prefetch" href="/assets/js/32.cb0b49c1.js"><link rel="prefetch" href="/assets/js/33.782d0813.js"><link rel="prefetch" href="/assets/js/34.09f56711.js"><link rel="prefetch" href="/assets/js/35.6d3e8a53.js"><link rel="prefetch" href="/assets/js/36.00abea01.js"><link rel="prefetch" href="/assets/js/37.489774cb.js"><link rel="prefetch" href="/assets/js/38.c12daea6.js"><link rel="prefetch" href="/assets/js/39.2d70a4b3.js"><link rel="prefetch" href="/assets/js/4.84b14fb6.js"><link rel="prefetch" href="/assets/js/40.04b2b1dd.js"><link rel="prefetch" href="/assets/js/41.7ba83c30.js"><link rel="prefetch" href="/assets/js/42.7874ba32.js"><link rel="prefetch" href="/assets/js/43.7e3a4633.js"><link rel="prefetch" href="/assets/js/44.f93042ec.js"><link rel="prefetch" href="/assets/js/45.2f7939d3.js"><link rel="prefetch" href="/assets/js/46.f7d5aad9.js"><link rel="prefetch" href="/assets/js/5.8613c109.js"><link rel="prefetch" href="/assets/js/7.e3359995.js"><link rel="prefetch" href="/assets/js/8.3f1218ae.js"><link rel="prefetch" href="/assets/js/9.27a33244.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.d9e995a1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6ee2d4db.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">xcc </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="https://rebel-writer-12b.notion.site/Engineering-Wiki-6f04c16f81ed4fbd8f6d599237c98dfe" target="_blank" rel="noopener noreferrer" class="nav-link external">Notions</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">xcc </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="https://rebel-writer-12b.notion.site/Engineering-Wiki-6f04c16f81ed4fbd8f6d599237c98dfe" target="_blank" rel="noopener noreferrer" class="nav-link external">Notions</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Python—垃圾回收机制
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">xucongcong</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-03-05T00:00:00.000Z">
      2021-03-05
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-532d3a9c><a href="/tag/Python" data-v-532d3a9c><span data-v-532d3a9c>Python</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><center><img src="/2022-1/py1.jpg" style="zoom:20%;"></center> <p>有很多不同的方法来实现垃圾回收，例如跟踪，引用计数，转义分析，时间戳和心跳信号等。不同的语言依赖于不同的垃圾回收实现，例如，有些将其与编译器和运行时系统集成在一起。而其他语言则可能需要事后设置，甚至可能需要重新编译。Python中垃圾收集器使用基于引用计数的方法。它在程序执行期间运行，并在对象的引用计数达到0时开始工作。</p> <br> <h2 id="_1、引用管理"><a href="#_1、引用管理" class="header-anchor">#</a> 1、引用管理</h2> <p>首先，内存管理是基于引用的管理。我们知道Python中，引用与对象是分离的，一个对象可以有多个引用，而每个对象都存有指向自己的引用计数。可以使用标准库<code>sys</code>查看某个对象的引用计数：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sys <span class="token keyword">import</span> getrefcount

a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 打印2</span>

b <span class="token operator">=</span> a
<span class="token keyword">print</span><span class="token punctuation">(</span>getrefcount<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 打印3</span>
</code></pre></div><blockquote><p>由于调用<code>getrefcount()</code>时又创建了一次引用，所以打印的引用计数会比实际多一个。</p></blockquote> <br> <h2 id="_2、对象引用对象"><a href="#_2、对象引用对象" class="header-anchor">#</a> 2、对象引用对象</h2> <p>Python中对象会引用别的对象，而容器对象的引用会构成很复杂的拓扑结构：</p> <div class="language-python extra-class"><pre class="language-python"><code>l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;k&quot;</span><span class="token punctuation">:</span> l<span class="token punctuation">}</span>

y <span class="token operator">=</span> <span class="token punctuation">[</span>l<span class="token punctuation">,</span> d<span class="token punctuation">]</span>
z <span class="token operator">=</span> <span class="token punctuation">[</span>y<span class="token punctuation">,</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>使用 <code>objgraph</code> 包可以绘制引用关系：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">import</span> objgraph
objgraph<span class="token punctuation">.</span>show_refs<span class="token punctuation">(</span><span class="token punctuation">[</span>z<span class="token punctuation">]</span><span class="token punctuation">,</span> filename<span class="token operator">=</span><span class="token string">'sample-graph.png'</span><span class="token punctuation">)</span>
</code></pre></div><p>绘制的 z 对象的引用图如下：</p> <center><img src="/2022-1/py2.png" style="zoom:80%;"></center> <br> <h2 id="_3、引用环"><a href="#_3、引用环" class="header-anchor">#</a> 3、引用环</h2> <p>两个对象相互引用，即构成了所谓的<strong>引用环</strong>：</p> <div class="language- extra-class"><pre class="language-text"><code>a = []
b = [a]
a.append(b)

objgraph.show_refs([a,b], filename='a-b.png')
</code></pre></div><center><img src="/2022-1/py3.png"></center> <br> <p>即使是单个对象，只需自己引用自己，也会构成引用环：</p> <div class="language- extra-class"><pre class="language-text"><code>a = []
a.append(a)

objgraph.show_refs([a], filename='a-b.png')
</code></pre></div><center><img src="/2022-1/py4.png"></center> <blockquote><p><code>del</code>关键字除了可以删除容器中的元素，还可以删除某个引用。</p></blockquote> <br> <h2 id="_4、垃圾回收"><a href="#_4、垃圾回收" class="header-anchor">#</a> 4、垃圾回收</h2> <p>CPython中的内存管理和垃圾回收有两个策略：</p> <ul><li><p>引用计数</p></li> <li><p>分代回收</p></li></ul> <br> <h3 id="_4-1-引用计数"><a href="#_4-1-引用计数" class="header-anchor">#</a> 4.1 引用计数</h3> <p>CPython中主要的垃圾收集机制是通过引用计数，且引用计数无法被禁用，而后面谈到的分代回收策略则可以禁止。</p> <p>原理上，Python的某个对象的引用计数变为0时，就要成为被回收的垃圾了。例如：</p> <div class="language-python extra-class"><pre class="language-python"><code>a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">del</span> a
</code></pre></div><p>当垃圾回收启动时，Python扫描到这个引用计数为0的对象，会将其所占据的内存清空。而垃圾回收是个费时费力的事，垃圾回收期间Python不能进行其他任务。频繁的垃圾回收会大大降低Python的效率，所以Python只会在特定条件下启动垃圾回收。Python运行时，会记录其中分配对象和取消分配对象的次数，当两者差值高于某个<strong>阈值</strong>，垃圾回收才会启动。</p> <br> <h3 id="_4-2-分代回收"><a href="#_4-2-分代回收" class="header-anchor">#</a> 4.2 分代回收</h3> <p>除了上面这种<strong>实时的</strong>，<strong>自动的</strong>基于引用计数的垃圾回收实现方法，Python还同时采用<strong>分代回收</strong>策略，这一次略的基本假设是，存活时间越久的对象，越不可能在以后成为垃圾。Python将所有对象分为三代，所有新建对象都是0代，如果经过一次扫描没被回收即成为了1代，以此类推。</p> <br>
Python的基于引用计数的方法是自动的，并且是实时发生的，而分代垃圾回收模块的操作是周期性的，可以手动调用，常用API：
<ul><li><p><code>get_shreshold()</code>方法可以查看触发垃圾收集的阈值：</p></li> <li><p><code>gc.get_count（）</code>方法可以查看内存中当前存在的各代对象数量</p></li> <li><p><code>gc.set_threshold（</code>）方法可以更改触发垃圾收集的阈值</p></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> gc
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">print</span><span class="token punctuation">(</span>gc<span class="token punctuation">.</span>get_threshold<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># (700, 10, 10)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> gc<span class="token punctuation">.</span>set_threshold<span class="token punctuation">(</span><span class="token number">700.10</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># 2代垃圾回收会更频繁</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> gc<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 手动触发垃圾回收</span>
</code></pre></div><p>对于每一代，垃圾收集器模块都有一个阈值对象。如果对象数超过该阈值，则垃圾收集器将触发收集过程，在该过程中幸存下来的对象会被归为下一代。默认情况下，Python对于最年轻的一代的阈值为700，对于两个较老的一代中的每个阈值为10。</p> <br> <h3 id="_4-3-引用环的回收"><a href="#_4-3-引用环的回收" class="header-anchor">#</a> 4.3 引用环的回收</h3> <p>分代回收可以检测和解决引用环问题，在Python 1.5中引入了循环检测算法，它跟踪容器对象，因为只有它们才能创建这种引用环。</p> <p>循环检测算法的基本原理是：Python会复制每个对象的引用计数，记为<code>gc_ref</code>。假设每个对象为<code>i</code>，该对象的计数为<code>gc_ref_i</code>。Python会遍历所有的对象<code>i</code>，对于每个对象<code>i</code>所引用的对象<code>j</code>，将<code>j</code>的<code>gc_ref_j</code>减1：</p> <center><img src="/2022-1/py5.png" style="zoom:60%;"></center> <p>遍历后，gc_ref不为0的对象及这些对象引用的对象，以及更下游的对象会被保留，而引用环中的对象会被回收。</p> <br> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><p><a href="https://www.cnblogs.com/vamei/p/3232088.html" target="_blank" rel="noopener noreferrer">Python深入06 Python的内存管理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，by Vamei</p></li> <li><p><a href="https://scoutapm.com/blog/python-garbage-collection" target="_blank" rel="noopener noreferrer">Python Garbage Collection: A Guide for Developers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://stackify.com/python-garbage-collection/" target="_blank" rel="noopener noreferrer">Python Garbage Collection: What It Is and How It Works<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1、引用管理" title="1、引用管理">1、引用管理</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2、对象引用对象" title="2、对象引用对象">2、对象引用对象</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3、引用环" title="3、引用环">3、引用环</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_4、垃圾回收" title="4、垃圾回收">4、垃圾回收</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-1-引用计数" title="4.1 引用计数">4.1 引用计数</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-2-分代回收" title="4.2 分代回收">4.2 分代回收</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-3-引用环的回收" title="4.3 引用环的回收">4.3 引用环的回收</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#参考" title="参考">参考</a></div></div></div></div> <footer class="footer" data-v-8eb634d6><div class="footer-left-wrap" data-v-8eb634d6><ul class="contact" data-v-8eb634d6><li class="contact-item" data-v-8eb634d6><a href="https://github.com/awesomexu" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-8eb634d6><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-8eb634d6></path></svg>
          
        </a></li><li class="contact-item" data-v-8eb634d6><a href="mailto:xcc_mail@163.com" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-8eb634d6><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-8eb634d6></path><polyline points="22,6 12,13 2,6" data-v-8eb634d6></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-8eb634d6><ul class="copyright" data-v-8eb634d6><li class="copyright-item" data-v-8eb634d6><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6>Privacy Policy</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.56bca4c3.js" defer></script><script src="/assets/js/6.80680de3.js" defer></script><script src="/assets/js/3.3f44ea24.js" defer></script><script src="/assets/js/24.44b9af71.js" defer></script>
  </body>
</html>
