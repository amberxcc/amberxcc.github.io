<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Flask-用户角色与权限管理 | xcc</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo/profile2.png">
    <meta name="description" content="Web 应用中的用户并非都具有同等地位，为此，要为所有用户分配一个角色，各个角色都通过权限列表定义允许用户执行的操作">
    
    <link rel="preload" href="/assets/css/0.styles.fe33cd63.css" as="style"><link rel="preload" href="/assets/js/app.d49401c7.js" as="script"><link rel="preload" href="/assets/js/6.b8e708a3.js" as="script"><link rel="preload" href="/assets/js/3.3f44ea24.js" as="script"><link rel="preload" href="/assets/js/13.8401e0b9.js" as="script"><link rel="prefetch" href="/assets/js/10.2a29879b.js"><link rel="prefetch" href="/assets/js/11.465376b6.js"><link rel="prefetch" href="/assets/js/12.3ceb53ff.js"><link rel="prefetch" href="/assets/js/14.f1548117.js"><link rel="prefetch" href="/assets/js/15.310ef410.js"><link rel="prefetch" href="/assets/js/16.2a04d5c4.js"><link rel="prefetch" href="/assets/js/17.e1ea1411.js"><link rel="prefetch" href="/assets/js/18.1743c483.js"><link rel="prefetch" href="/assets/js/19.51a1b18f.js"><link rel="prefetch" href="/assets/js/20.a57b6ac2.js"><link rel="prefetch" href="/assets/js/21.6ca00cc5.js"><link rel="prefetch" href="/assets/js/22.3749550e.js"><link rel="prefetch" href="/assets/js/23.3d2bceb7.js"><link rel="prefetch" href="/assets/js/24.91c37a3e.js"><link rel="prefetch" href="/assets/js/25.27a05fd1.js"><link rel="prefetch" href="/assets/js/26.76c0f96a.js"><link rel="prefetch" href="/assets/js/27.7dd0ab4c.js"><link rel="prefetch" href="/assets/js/28.072c3ce1.js"><link rel="prefetch" href="/assets/js/29.834ade1f.js"><link rel="prefetch" href="/assets/js/30.5f7f40ee.js"><link rel="prefetch" href="/assets/js/31.4cc890a9.js"><link rel="prefetch" href="/assets/js/32.86a374c5.js"><link rel="prefetch" href="/assets/js/33.c4856b20.js"><link rel="prefetch" href="/assets/js/34.eb3f0185.js"><link rel="prefetch" href="/assets/js/35.369fe440.js"><link rel="prefetch" href="/assets/js/36.00abea01.js"><link rel="prefetch" href="/assets/js/37.e7c8ccab.js"><link rel="prefetch" href="/assets/js/38.fa25c440.js"><link rel="prefetch" href="/assets/js/39.613c74e5.js"><link rel="prefetch" href="/assets/js/4.84b14fb6.js"><link rel="prefetch" href="/assets/js/40.2c26affe.js"><link rel="prefetch" href="/assets/js/41.c1f10880.js"><link rel="prefetch" href="/assets/js/42.13fed834.js"><link rel="prefetch" href="/assets/js/43.3c20f821.js"><link rel="prefetch" href="/assets/js/5.8613c109.js"><link rel="prefetch" href="/assets/js/7.e3359995.js"><link rel="prefetch" href="/assets/js/8.a97dd115.js"><link rel="prefetch" href="/assets/js/9.27a33244.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.d9e995a1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fe33cd63.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">xcc </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="https://rebel-writer-12b.notion.site/Engineering-Wiki-6f04c16f81ed4fbd8f6d599237c98dfe" target="_blank" rel="noopener noreferrer" class="nav-link external">Notions</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">xcc </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="https://rebel-writer-12b.notion.site/Engineering-Wiki-6f04c16f81ed4fbd8f6d599237c98dfe" target="_blank" rel="noopener noreferrer" class="nav-link external">Notions</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Flask-用户角色与权限管理
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">xucongcong</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2021-03-04T00:00:00.000Z">
      2021-03-04
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-532d3a9c><a href="/tag/Flask" data-v-532d3a9c><span data-v-532d3a9c>Flask</span></a></li><li class="post-tag" data-v-532d3a9c><a href="/tag/Python" data-v-532d3a9c><span data-v-532d3a9c>Python</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>Web 应用中的用户并非都具有同等地位，为此，要为所有用户分配一个<strong>角色</strong>。</p> <p>在应用中实现角色有多种方法。具体采用何种实现方法取决于所需角色的数量和细分程度。例如，简单的应用可能只需要两个角色，一个表示普通用户，一个表示管理员。对于这种情况，在 <code>User</code> 模型中添加一个 <code>is_administrator</code> 布尔值字段可能就够了。复杂的应用可能需要在普通用户和管理员之间再细分出多个不同等级的角色。有些用户可能又有多个角色，故赋予用户一系列独立的<strong>权限</strong>或许更合适。</p> <p>以下介绍的用户角色实现方式结合了分立的角色和权限，赋予用户分立的角色，但是各个角色都通过权限列表定义允许用户执行的操作。</p> <br> <h2 id="_1、数据库中表示"><a href="#_1、数据库中表示" class="header-anchor">#</a> 1、数据库中表示</h2> <br> <h3 id="_1-1-定义角色表"><a href="#_1-1-定义角色表" class="header-anchor">#</a> 1.1 定义角色表</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Role</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'roles'</span>
    <span class="token comment"># ...</span>
    permissions <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p>permissions字段表示角色的权限，含义如下：</p> <table><thead><tr><th style="text-align:center;">操作</th> <th style="text-align:center;">权限名</th> <th style="text-align:center;">权限值</th></tr></thead> <tbody><tr><td style="text-align:center;">关注用户</td> <td style="text-align:center;"><code>FOLLOW</code></td> <td style="text-align:center;"><code>1</code></td></tr> <tr><td style="text-align:center;">在他人的文章中发表评论</td> <td style="text-align:center;"><code>COMMENT</code></td> <td style="text-align:center;"><code>2</code></td></tr> <tr><td style="text-align:center;">写文章</td> <td style="text-align:center;"><code>WRITE</code></td> <td style="text-align:center;"><code>4</code></td></tr> <tr><td style="text-align:center;">管理他人发表的评论</td> <td style="text-align:center;"><code>MODERATE</code></td> <td style="text-align:center;"><code>8</code></td></tr> <tr><td style="text-align:center;">管理员权限</td> <td style="text-align:center;"><code>ADMIN</code></td> <td style="text-align:center;"><code>16</code></td></tr></tbody></table> <br> <h3 id="_1-2-定义权限常量"><a href="#_1-2-定义权限常量" class="header-anchor">#</a> 1.2 定义权限常量</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Permission</span><span class="token punctuation">:</span>
    FOLLOW <span class="token operator">=</span> <span class="token number">1</span>
    COMMENT <span class="token operator">=</span> <span class="token number">2</span>
    WRITE <span class="token operator">=</span> <span class="token number">4</span>
    MODERATE <span class="token operator">=</span> <span class="token number">8</span>
    ADMIN <span class="token operator">=</span> <span class="token number">16</span>
</code></pre></div><p>使用 2 的幂表示权限值有个好处：每种不同的权限组合对应的值都是唯一的，方便存入角色的 <code>permissions</code> 字段。</p> <br> <h3 id="_1-3-管理角色权限"><a href="#_1-3-管理角色权限" class="header-anchor">#</a> 1.3 管理角色权限</h3> <p>添加这些权限常量之后，可以在 <code>Role</code> 模型中定义几个新方法，用于管理权限：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Role</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>

    <span class="token keyword">def</span> <span class="token function">add_permission</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>has_permission<span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>permissions <span class="token operator">+=</span> perm

    <span class="token keyword">def</span> <span class="token function">remove_permission</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>has_permission<span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>permissions <span class="token operator">-=</span> perm

    <span class="token keyword">def</span> <span class="token function">reset_permissions</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>permissions <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">has_permission</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>permissions <span class="token operator">&amp;</span> perm <span class="token operator">==</span> perm
</code></pre></div><p><strong>示例：</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> role <span class="token operator">=</span> Role<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'User'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> role<span class="token punctuation">.</span>add_permission<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> r<span class="token punctuation">.</span>has_permission<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">)</span>
<span class="token boolean">True</span>
</code></pre></div><center><img src="/2022-1/flask8.png"></center> <br> <p>可在模型中增加静态方法，用于生成常用角色：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Role</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># ...</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">insert_roles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        roles <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'User'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Permission<span class="token punctuation">.</span>FOLLOW<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>COMMENT<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'Moderator'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Permission<span class="token punctuation">.</span>FOLLOW<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>COMMENT<span class="token punctuation">,</span>
            Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>MODERATE<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'Administrator'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Permission<span class="token punctuation">.</span>FOLLOW<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>COMMENT<span class="token punctuation">,</span>
            Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">,</span> Permission<span class="token punctuation">.</span>MODERATE<span class="token punctuation">,</span>
            Permission<span class="token punctuation">.</span>ADMIN<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">for</span> r <span class="token keyword">in</span> roles<span class="token punctuation">:</span>
        <span class="token comment"># ...</span>
</code></pre></div><br> <h2 id="_2、给用户添加角色"><a href="#_2、给用户添加角色" class="header-anchor">#</a> 2、给用户添加角色</h2> <ul><li><p>设置默认角色（生成User对象时自动配置角色信息）</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>UserMixin<span class="token punctuation">,</span> db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>role <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>email <span class="token operator">==</span> current_app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'FLASKY_ADMIN'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>role <span class="token operator">=</span> Role<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'User'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># ...</span>
</code></pre></div></li> <li><p>生成用户后手动设置角色</p> <div class="language- extra-class"><pre class="language-text"><code>user = User(name = 'xxx')

user.role = Role.query.filter_by(name='User').first()
</code></pre></div></li></ul> <br> <h2 id="_3、检测用户权限"><a href="#_3、检测用户权限" class="header-anchor">#</a> 3、检测用户权限</h2> <p>为了简化角色和权限的实现过程，可在 <code>User</code> 模型中添加一个辅助方法，检查赋予用户的角色是否有某项权限。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> flask_login <span class="token keyword">import</span> UserMixin<span class="token punctuation">,</span> AnonymousUserMixin

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>UserMixin<span class="token punctuation">,</span> db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>

    <span class="token keyword">def</span> <span class="token function">can</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> perm<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>role <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> self<span class="token punctuation">.</span>role<span class="token punctuation">.</span>has_permission<span class="token punctuation">(</span>perm<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">is_administrator</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>ADMIN<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">AnonymousUser</span><span class="token punctuation">(</span>AnonymousUserMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">can</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">is_administrator</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>

login_manager<span class="token punctuation">.</span>anonymous_user <span class="token operator">=</span> AnonymousUser
</code></pre></div><br> <p>如果想让视图函数只对具有特定权限的用户开放，可以使用自定义的装饰器。下面实现了两个装饰器，一个用于检查常规权限，另一个专门检查管理员权限。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">permission_required</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token decorator annotation punctuation">@wraps</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">def</span> <span class="token function">decorated_function</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> current_user<span class="token punctuation">.</span>can<span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">:</span>
                abort<span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> f<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> decorated_function
    <span class="token keyword">return</span> decorator

<span class="token keyword">def</span> <span class="token function">admin_required</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> permission_required<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>ADMIN<span class="token punctuation">)</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
</code></pre></div><p>使用示例：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@main<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@login_required</span>
<span class="token decorator annotation punctuation">@admin_required</span>
<span class="token keyword">def</span> <span class="token function">for_admins_only</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;For administrators!&quot;</span>
</code></pre></div><br> <h2 id="_4、在模板中使用权限常量"><a href="#_4、在模板中使用权限常量" class="header-anchor">#</a> 4、在模板中使用权限常量</h2> <p><code>app/main/__init__.py</code>：把 <code>Permission</code> 类加入模板上下文：</p> <div class="language- extra-class"><pre class="language-text"><code>@main.app_context_processor
def inject_permissions():
    return dict(Permission=Permission)
</code></pre></div><br> <h2 id="_5、测试"><a href="#_5、测试" class="header-anchor">#</a> 5、测试</h2> <p><code>tests/test_user_model.py</code>：添加角色和权限的单元测试</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">UserModelTestCase</span><span class="token punctuation">(</span>unittest<span class="token punctuation">.</span>TestCase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>

    <span class="token keyword">def</span> <span class="token function">test_user_role</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        u <span class="token operator">=</span> User<span class="token punctuation">(</span>email<span class="token operator">=</span><span class="token string">'john@example.com'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'cat'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>FOLLOW<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>COMMENT<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertTrue<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>MODERATE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">test_anonymous_user</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        u <span class="token operator">=</span> AnonymousUser<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>FOLLOW<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>COMMENT<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>MODERATE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>assertFalse<span class="token punctuation">(</span>u<span class="token punctuation">.</span>can<span class="token punctuation">(</span>Permission<span class="token punctuation">.</span>ADMIN<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1、数据库中表示" title="1、数据库中表示">1、数据库中表示</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-1-定义角色表" title="1.1 定义角色表">1.1 定义角色表</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-2-定义权限常量" title="1.2 定义权限常量">1.2 定义权限常量</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-3-管理角色权限" title="1.3 管理角色权限">1.3 管理角色权限</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2、给用户添加角色" title="2、给用户添加角色">2、给用户添加角色</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3、检测用户权限" title="3、检测用户权限">3、检测用户权限</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_4、在模板中使用权限常量" title="4、在模板中使用权限常量">4、在模板中使用权限常量</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_5、测试" title="5、测试">5、测试</a></div></div></div></div> <footer class="footer" data-v-8eb634d6><div class="footer-left-wrap" data-v-8eb634d6><ul class="contact" data-v-8eb634d6><li class="contact-item" data-v-8eb634d6><a href="https://github.com/awesomexu" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-8eb634d6><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-8eb634d6></path></svg>
          
        </a></li><li class="contact-item" data-v-8eb634d6><a href="mailto:xcc_mail@163.com" class="nav-link external" data-v-8eb634d6><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-8eb634d6><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-8eb634d6></path><polyline points="22,6 12,13 2,6" data-v-8eb634d6></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-8eb634d6><ul class="copyright" data-v-8eb634d6><li class="copyright-item" data-v-8eb634d6><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-8eb634d6>Privacy Policy</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d49401c7.js" defer></script><script src="/assets/js/6.b8e708a3.js" defer></script><script src="/assets/js/3.3f44ea24.js" defer></script><script src="/assets/js/13.8401e0b9.js" defer></script>
  </body>
</html>
